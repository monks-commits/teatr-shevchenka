<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>Друк квитків — каса</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:#f3f4f6;
      color:#111827;
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:18px 14px 60px;
    }
    .card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:14px 14px;
      margin-bottom:14px;
      box-shadow:0 10px 25px rgba(15,23,42,0.05);
    }
    .title{
      font-weight:900;
      margin:0 0 8px;
      font-size:18px;
    }
    .meta{ color:#6b7280; font-size:13px; line-height:1.35; }
    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .btn{
      border:0;
      border-radius:12px;
      padding:11px 14px;
      font-weight:800;
      cursor:pointer;
    }
    .btn-primary{ background:#2563eb; color:#fff; }
    .btn-ghost{ background:#fff; color:#111827; border:1px solid #e5e7eb; }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    th,td{
      border-bottom:1px solid #eef2f7;
      padding:8px 8px;
      text-align:left;
      vertical-align:top;
    }
    th{ color:#6b7280; font-weight:800; font-size:12px; text-transform:uppercase; letter-spacing:.06em; }

    /* ===== Ticket block (термо формат) ===== */
    @page { size: 80mm 200mm; margin: 5mm; }

    .print-area{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .ticket{
      width:260px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 6px 20px rgba(15,23,42,0.15);
      padding:14px 16px 12px;
      box-sizing:border-box;
      border:1px solid #e5e7eb;
    }
    .ticket-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px}
    .logo-mark{width:32px;height:32px;border-radius:999px;background:#111827;color:#f9fafb;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px}
    .brand-text{margin-left:8px;display:flex;flex-direction:column;gap:2px}
    .brand-name{font-size:12px;font-weight:800;color:#111827;line-height:1.1}
    .brand-tagline{font-size:10px;color:#6b7280;line-height:1.1}
    .ticket-meta-top{margin-top:2px;font-size:10px;color:#6b7280;text-align:right}
    .ticket-title{margin-top:8px;font-size:13px;font-weight:900;color:#111827;text-transform:uppercase}
    .ticket-sub{font-size:11px;color:#374151;margin-top:2px}
    .ticket-row{display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#111827;margin-top:6px}
    .ticket-divider{margin:8px 0;border-bottom:1px dashed #d1d5db}
    .ticket-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px 10px;font-size:11px;margin-top:4px}
    .label{display:block;font-size:9px;text-transform:uppercase;letter-spacing:.08em;color:#6b7280}
    .value{font-weight:800;color:#111827}
    .ticket-footer{margin-top:8px;font-size:9px;color:#6b7280;line-height:1.2}
    .qr-placeholder{margin-top:8px;height:64px;border-radius:8px;border:1px dashed #d1d5db;display:flex;align-items:center;justify-content:center;font-size:9px;color:#9ca3af}

    .page-break{ page-break-after: always; break-after: page; }

    /* print mode */
    @media print {
      body{ background:#fff; }
      .no-print{ display:none !important; }
      .wrap{ max-width:none; padding:0; }
      .ticket{
        box-shadow:none;
        border-radius:0;
        width:100%;
        border:none;
      }
      .print-area{ gap:0; }
      .page-break{ page-break-after: always; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card no-print">
      <h1 class="title">Підтвердження друку</h1>
      <div class="meta" id="metaLine">—</div>

      <div class="meta" style="margin-top:10px;">
        ⚠️ Принтер обирається у стандартному вікні друку (це обмеження браузера).
      </div>

      <div class="btnrow">
        <button class="btn btn-primary" id="btnPrint">Друкувати</button>
        <button class="btn btn-ghost" id="btnCancel">Скасувати</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Зона</th>
            <th>Ряд</th>
            <th>Місце</th>
            <th>Ціна</th>
          </tr>
        </thead>
        <tbody id="listBody"></tbody>
      </table>
    </div>

    <!-- печатная область -->
    <div class="print-area" id="printArea"></div>
  </div>

  <script>
    function b64DecodeUnicode(str) {
      try {
        return decodeURIComponent(escape(atob(str)));
      } catch(e) { return ''; }
    }

    function getData() {
      const qs = new URLSearchParams(location.search);
      const enc = qs.get('data') || '';
      if (!enc) return null;
      const json = b64DecodeUnicode(decodeURIComponent(enc));
      if (!json) return null;
      try { return JSON.parse(json); } catch(e){ return null; }
    }

    function pad2(n){ return String(n).padStart(2,'0'); }

    function makeOrder(prefix){
      const d = new Date();
      return `${prefix}-${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}-${d.getHours()}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
    }

    function ticketHTML(payload, item, order){
      const brandName = payload?.theatre?.name || 'Театр';
      const brandTagline = payload?.theatre?.tagline || 'Офіційний продаж квитків';

      const showTitle = payload?.show?.title || 'Вистава';
      const showSubtitle = payload?.show?.subtitle || '';
      const showDate = payload?.show?.date || '';
      const channel = payload?.channel || 'Каса';
      const curr = payload?.currency || 'грн';

      return `
        <div class="ticket">
          <div class="ticket-header">
            <div style="display:flex;align-items:center;">
              <div class="logo-mark">Т</div>
              <div class="brand-text">
                <div class="brand-name">${brandName}</div>
                <div class="brand-tagline">${brandTagline}</div>
              </div>
            </div>
            <div class="ticket-meta-top">${order}</div>
          </div>

          <div class="ticket-title">${showTitle}</div>
          <div class="ticket-sub">${showSubtitle}</div>

          <div class="ticket-row">
            <span>${showDate}</span>
            <span><strong>${item.zone || ''}</strong></span>
          </div>

          <div class="ticket-divider"></div>

          <div class="ticket-grid">
            <div>
              <span class="label">Ряд</span>
              <span class="value">${item.row}</span>
            </div>
            <div>
              <span class="label">Місце</span>
              <span class="value">${item.seat}</span>
            </div>
            <div>
              <span class="label">Ціна</span>
              <span class="value">${item.price} ${curr}</span>
            </div>
            <div>
              <span class="label">Канал</span>
              <span class="value">${channel}</span>
            </div>
          </div>

          <div class="ticket-divider"></div>

          <div class="ticket-footer">
            Квиток дійсний на одну особу. Повернення та обмін квитків відбувається згідно з правилами театру.
            Зберігайте квиток до кінця вистави.
          </div>

          <div class="qr-placeholder">QR / штрих-код (додамо пізніше)</div>
        </div>
        <div class="page-break"></div>
      `;
    }

    (function init(){
      const payload = getData();
      const listBody = document.getElementById('listBody');
      const printArea = document.getElementById('printArea');
      const metaLine = document.getElementById('metaLine');

      if (!payload || !Array.isArray(payload.items) || payload.items.length === 0){
        metaLine.textContent = 'Немає даних для друку.';
        return;
      }

      const total = payload.items.reduce((s,i)=>s+Number(i.price||0),0);
      metaLine.textContent = `${payload?.theatre?.name || 'Театр'} • Квитків: ${payload.items.length} • Сума: ${total} ${payload.currency || 'грн'}`;

      // list
      payload.items.forEach((it, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${it.zone || ''}</td>
          <td>${it.row}</td>
          <td>${it.seat}</td>
          <td>${it.price} ${payload.currency || 'грн'}</td>
        `;
        listBody.appendChild(tr);
      });

      // tickets
      const prefix = payload.orderPrefix || 'ORD';
      const baseOrder = makeOrder(prefix);
      let html = '';
      payload.items.forEach((it, idx)=>{
        const order = `${baseOrder}-${idx+1}`;
        html += ticketHTML(payload, it, order);
      });
      printArea.innerHTML = html;

      document.getElementById('btnPrint').addEventListener('click', ()=>{
        window.print();
      });
      document.getElementById('btnCancel').addEventListener('click', ()=>{
        window.close();
      });
    })();
  </script>
</body>
</html>
