<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Оплата</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:820px}
    .card{border:1px solid #e5e7eb;border-radius:16px;padding:20px;margin:14px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{display:block;font-size:14px;color:#111827;margin-bottom:6px}
    input{padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;min-width:280px}
    button{padding:12px 16px;border:0;border-radius:12px;background:#111827;color:#fff;cursor:pointer}
    .muted{color:#6b7280;font-size:14px}
    .err{color:#b91c1c}
    .ok{color:#047857}
    pre{white-space:pre-wrap;background:#f9fafb;border:1px solid #eee;border-radius:12px;padding:12px}
  </style>
</head>
<body>
  <h1>Підтвердження та оплата</h1>

  <div class="card">
    <div id="summary" class="muted">Завантаження…</div>
  </div>

  <div class="card">
    <h2>Контакт покупця</h2>
    <div class="row">
      <div>
        <label>Імʼя</label>
        <input id="buyer_name" placeholder="Ваше імʼя" />
      </div>
      <div>
        <label>Email (куди надійде квиток)</label>
        <input id="buyer_email" placeholder="name@example.com" />
      </div>
    </div>
    <p class="muted">Email потрібен, інакше функція відправки квитка не зможе спрацювати.</p>
  </div>

  <div class="card">
    <h2>Оплата онлайн</h2>
    <div id="status" class="muted"></div>
    <div id="paybox"></div>
    <div id="debug" class="muted"></div>
  </div>

<script>
  // === ВАЖНО: Supabase проект, де лежать edge functions liqpay-init / liqpay-callback / issue-and-email ===
  const SUPABASE_URL = "https://yqhzekifwxotizsmaeaf.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxaHpla2lmd3hvdGl6c21hZWFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMzQyNjgsImV4cCI6MjA3NjgxMDI2OH0.lUoppCppKZisZdyOrreCov_-xEOCvGuwxd28XZY4O_k";

  // GitHub Pages base для репо:
  // https://monks-commits.github.io/teatr-shevchenka/...
  function guessBasePath() {
    const p = location.pathname;
    // если /teatr-shevchenka/checkout.html -> base="/teatr-shevchenka"
    const idx = p.indexOf("/teatr-shevchenka/");
    if (idx !== -1) return "/teatr-shevchenka";
    return ""; // для домена типа vash-admin.com
  }
  const BASE = guessBasePath();

  // result_url (куда вернёмся после оплаты)
  const RESULT_URL = location.origin + BASE + "/thanks.html";
  // server_url (куда LiqPay шлёт callback)
  const SERVER_URL = `${SUPABASE_URL}/functions/v1/liqpay-callback`;

  function qs(name){ return new URLSearchParams(location.search).get(name) || ""; }

  const order_id = qs("order_id") || ("ORD-" + Date.now());
  const amount = Number(qs("amount") || "10");
  const currency = (qs("currency") || "UAH").toUpperCase();

  const show_slug = qs("show") || qs("slug") || "";
  const title = qs("title") || "";
  const seats_raw = qs("seats") || "";
  const seats = seats_raw ? seats_raw.split(";").map(s=>s.trim()).filter(Boolean) : [];

  const inputName = document.getElementById("buyer_name");
  const inputEmail = document.getElementById("buyer_email");

  inputName.value = qs("name") || "";
  inputEmail.value = qs("email") || "";

  const summary = document.getElementById("summary");
  summary.innerHTML = `
    <div><b>Номер замовлення:</b> ${order_id}</div>
    <div><b>Сума:</b> ${amount} ${currency}</div>
    <div><b>Вистава:</b> ${title || show_slug || "-"}</div>
    <div><b>Місця:</b> ${seats.length ? seats.join(", ") : "-"}</div>
    <div class="muted">Повернення після оплати: ${RESULT_URL}</div>
  `;

  async function supaUpsertOrderV2(payload){
    // Таблица orders_v2 у тебя UNRESTRICTED => можно писать anon key.
    const url = `${SUPABASE_URL}/rest/v1/orders_v2?on_conflict=order_id`;
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
        "Prefer":"resolution=merge-duplicates,return=minimal"
      },
      body: JSON.stringify([payload])
    });
    if (!res.ok) {
      const txt = await res.text().catch(()=> "");
      throw new Error(`orders_v2 upsert failed: HTTP ${res.status} ${txt}`);
    }
  }

  async function initPayment(payload) {
    const res = await fetch(`${SUPABASE_URL}/functions/v1/liqpay-init`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
        "apikey": SUPABASE_ANON_KEY,
      },
      body: JSON.stringify(payload),
    });
    let data = null;
    try { data = await res.json(); } catch (_) {}
    if (!res.ok) {
      const msg = (data && (data.message || data.error)) || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  function renderLiqPayForm(data, signature){
    const box = document.getElementById("paybox");
    box.innerHTML = `
      <form method="POST" action="https://www.liqpay.ua/api/3/checkout" accept-charset="utf-8">
        <input type="hidden" name="data" value="${data}">
        <input type="hidden" name="signature" value="${signature}">
        <button type="submit">Оплатити через LiqPay</button>
      </form>
      <p class="muted">Після оплати ви повернетесь на сторінку підтвердження, а квиток прийде на email.</p>
    `;
  }

  async function start(){
    const status = document.getElementById("status");
    const debug = document.getElementById("debug");

    try{
      status.innerHTML = "Готуємо замовлення…";

      const buyer_email = (inputEmail.value || "").trim();
      const buyer_name = (inputName.value || "").trim();

      if (!buyer_email || !buyer_email.includes("@")) {
        status.innerHTML = `<span class="err">Введіть коректний email — без нього квиток не відправиться.</span>`;
        return;
      }

      // 1) Пишем order в orders_v2 ДО оплаты
      await supaUpsertOrderV2({
        order_id,
        amount,
        currency,
        status: "created",
        buyer_email,
        buyer_name,
        show_slug: show_slug || null,
        updated_at: new Date().toISOString(),
        created_at: new Date().toISOString()
      });

      // 2) Получаем data/signature
      const init = await initPayment({
        order_id,
        amount,
        currency,
        show_slug: show_slug || null,
        title: title || null,
        seats,
        result_url: RESULT_URL,
        server_url: SERVER_URL,
        buyer_email,
        buyer_name
      });

      status.innerHTML = `<span class="ok">Готово. Натисніть кнопку оплати.</span>`;
      renderLiqPayForm(init.data, init.signature);

      debug.innerHTML = `<pre>${JSON.stringify({ order_id, amount, currency, RESULT_URL, SERVER_URL }, null, 2)}</pre>`;
    } catch(e){
      status.innerHTML = `<span class="err">Помилка: ${e.message || e}</span>`;
    }
  }

  // Автостарт, но если email пустой — ждём ввода
  inputEmail.addEventListener("input", ()=>start());
  inputName.addEventListener("input", ()=>{});
  start();
</script>
</body>
</html>
