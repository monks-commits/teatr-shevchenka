<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Оформлення замовлення</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    .wrap { max-width: 860px; margin: 0 auto; padding: 18px 14px; }
    .card { background:#fff; border-radius:14px; box-shadow: 0 2px 12px rgba(0,0,0,.08); padding:16px; margin-bottom:14px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid1 { display:grid; grid-template-columns: 1fr; gap:12px; }
    label { display:block; font-size:14px; margin-bottom:6px; opacity:.85; }
    input { width:100%; padding:10px 12px; border:1px solid rgba(0,0,0,.15); border-radius:10px; }
    .btn { display:inline-flex; align-items:center; justify-content:center; padding:12px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:600; }
    .btn-primary { background:#7a1c1c; color:#fff; }
    .btn-ghost { background:transparent; border:1px solid rgba(0,0,0,.15); }
    .muted { opacity:.75; font-size:14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .seats { font-weight:600; }
    .error { color:#b00020; font-size:14px; margin-top:8px; }
    .ok { color:#0a7a2e; font-size:14px; margin-top:8px; }
    .divider { height:1px; background:rgba(0,0,0,.08); margin:12px 0; }
    code.small { font-size:12px; opacity:.75; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h1 style="margin:0 0 6px 0;">Оформлення замовлення</h1>
          <div class="muted">Перевірте місця та заповніть контактні дані. Оплата — через LiqPay.</div>
        </div>
        <div>
          <a class="btn btn-ghost" href="./afisha.html">← До афіші</a>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <div class="muted">Спектакль (show_slug):</div>
          <div style="font-weight:700; font-size:16px;" id="showSlugView">—</div>
        </div>
        <div style="text-align:right;">
          <div class="muted">Сума до сплати:</div>
          <div style="font-weight:800; font-size:18px;">
            <span id="amountView">0</span> <span id="currencyView">UAH</span>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="muted">Обрані місця:</div>
      <div class="seats" id="seatsView" style="margin-top:6px;">—</div>

      <div class="muted" style="margin-top:10px;">
        Формат для квитка: <strong>Ряд №, місце №</strong>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px 0; font-size:18px;">Контактні дані</h2>

      <form id="checkoutForm" class="grid1" autocomplete="on">
        <div class="grid">
          <div>
            <label for="buyerName">Імʼя та прізвище</label>
            <input id="buyerName" name="buyerName" placeholder="Напр.: Олександр Р." required />
          </div>
          <div>
            <label for="buyerEmail">Email</label>
            <input id="buyerEmail" name="buyerEmail" type="email" placeholder="name@example.com" required />
          </div>
        </div>

        <div class="grid">
          <div>
            <label for="buyerPhone">Телефон (необовʼязково)</label>
            <input id="buyerPhone" name="buyerPhone" placeholder="+380..." />
          </div>
          <div>
            <label> </label>
            <div class="muted" style="padding:10px 0;">
              Після оплати сторінка LiqPay поверне вас на «Дякуємо».
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:4px;">
          <button class="btn btn-primary" type="submit" id="payBtn">Перейти до оплати</button>
          <div class="muted">
            Натискаючи «Перейти до оплати», ви погоджуєтесь з правилами повернення.
          </div>
        </div>

        <div id="msg" class="error" style="display:none;"></div>
        <div id="ok" class="ok" style="display:none;"></div>
      </form>

      <div class="divider"></div>
      <div class="muted">
        Якщо щось пішло не так — оновіть сторінку та спробуйте ще раз.
      </div>
    </div>

    <div class="card">
      <div class="muted">
        Технічна довідка (для тесту):<br/>
        <code class="small" id="debugInfo">—</code>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // =========================
    // CONFIG (ОБОВʼЯЗКОВО ЗАМІНИТИ!)
    // =========================
    const SUPABASE_URL = "https://YOUR_NEW_PROJECT_REF.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_NEW_ANON_KEY";

    // Edge Function в НОВОМ Supabase:
    const LIQPAY_INIT_URL = `${SUPABASE_URL}/functions/v1/liqpay-init`;

    // =========================
    // Helpers
    // =========================
    function qs(name) {
      return new URLSearchParams(location.search).get(name);
    }

    function showMessage(text, ok=false) {
      const elErr = document.getElementById("msg");
      const elOk  = document.getElementById("ok");
      if (ok) {
        elErr.style.display = "none";
        elOk.style.display = "block";
        elOk.textContent = text;
      } else {
        elOk.style.display = "none";
        elErr.style.display = "block";
        elErr.textContent = text;
      }
    }

    function safeJsonParse(v, fallback) {
      try { return JSON.parse(v); } catch { return fallback; }
    }

    function normalizeSeatLabel(s) {
      // приводим к единому виду "Ряд X, місце Y"
      // допускаем варианты типа "ряд 2, місце 5" / "Ряд 2 місце 5" / "2-5"
      const str = String(s || "").trim();
      if (!str) return "";

      // если уже похоже на "Ряд N, місце M"
      const m1 = str.match(/ряд\s*([0-9]+)\s*[, ]\s*місце\s*([0-9]+)/i);
      if (m1) return `Ряд ${parseInt(m1[1],10)}, місце ${parseInt(m1[2],10)}`;

      // если формата "P14-M17" (на всякий случай) — НЕ ИДЕАЛЬНО, но не падаем
      const m2 = str.match(/^P(\d+)-M(\d+)$/i);
      if (m2) return `Ряд ${parseInt(m2[1],10)}, місце ${parseInt(m2[2],10)}`;

      // если "2-5" или "2:5"
      const m3 = str.match(/^(\d+)\s*[-:]\s*(\d+)$/);
      if (m3) return `Ряд ${parseInt(m3[1],10)}, місце ${parseInt(m3[2],10)}`;

      // иначе возвращаем как есть (лучше не ломать данные)
      return str;
    }

    function getSeatsFromStorageOrQuery() {
      // 1) URL: ?seats=... (json или csv)
      const qSeats = qs("seats");
      if (qSeats) {
        const maybeJson = safeJsonParse(qSeats, null);
        if (Array.isArray(maybeJson)) return maybeJson.map(normalizeSeatLabel).filter(Boolean);
        // csv
        return qSeats.split(",").map(x => normalizeSeatLabel(x)).filter(Boolean);
      }

      // 2) localStorage: пробуем несколько ключей, чтобы не зависеть от старой реализации
      const keys = ["selectedSeats", "seats", "cartSeats", "basketSeats"];
      for (const k of keys) {
        const v = localStorage.getItem(k);
        if (!v) continue;
        const arr = safeJsonParse(v, null);
        if (Array.isArray(arr) && arr.length) return arr.map(normalizeSeatLabel).filter(Boolean);
      }

      return [];
    }

    function getShowSlug() {
      return qs("show_slug") || qs("show") || localStorage.getItem("show_slug") || "";
    }

    function getAmount() {
      // 1) URL ?amount=
      const q = qs("amount");
      if (q && !Number.isNaN(Number(q))) return Number(q);

      // 2) localStorage common keys
      const keys = ["amount", "total", "basketTotal", "sum"];
      for (const k of keys) {
        const v = localStorage.getItem(k);
        if (v && !Number.isNaN(Number(v))) return Number(v);
      }

      return 0;
    }

    function makeOrderId(prefix="TS") {
      const rnd = Math.random().toString(36).slice(2, 8).toUpperCase();
      const ts = Date.now();
      return `${prefix}-${ts}-${rnd}`;
    }

    // =========================
    // Init
    // =========================
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const seats = getSeatsFromStorageOrQuery();
    const show_slug = getShowSlug();
    const amount = getAmount();
    const currency = "UAH";

    document.getElementById("showSlugView").textContent = show_slug || "—";
    document.getElementById("amountView").textContent = String(amount || 0);
    document.getElementById("currencyView").textContent = currency;
    document.getElementById("seatsView").textContent = seats.length ? seats.join("; ") : "—";

    document.getElementById("debugInfo").textContent =
      `SUPABASE_URL=${SUPABASE_URL} | init=${LIQPAY_INIT_URL} | show_slug=${show_slug} | seats=${seats.length} | amount=${amount}`;

    if (!SUPABASE_URL.includes("supabase.co") || SUPABASE_ANON_KEY === "YOUR_NEW_ANON_KEY") {
      showMessage("Потрібно підставити SUPABASE_URL та SUPABASE_ANON_KEY нового проєкту (CONFIG на початку файлу).");
    }

    // =========================
    // Submit: call liqpay-init -> redirect to LiqPay
    // =========================
    const form = document.getElementById("checkoutForm");
    const payBtn = document.getElementById("payBtn");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!show_slug) {
        showMessage("Не визначено спектакль (show_slug). Поверніться на афішу та оберіть сеанс.");
        return;
      }
      if (!seats.length) {
        showMessage("Не знайдено обрані місця. Поверніться до схеми залу та оберіть місця.");
        return;
      }
      if (!amount || amount <= 0) {
        showMessage("Сума замовлення не визначена. Перевірте вибір місць/цін.");
        return;
      }

      payBtn.disabled = true;
      showMessage("Готуємо платіж…", true);

      const buyer_name = document.getElementById("buyerName").value.trim();
      const buyer_email = document.getElementById("buyerEmail").value.trim();
      const buyer_phone = document.getElementById("buyerPhone").value.trim();

      // фиксируем order_id, чтобы Thanks-страница могла его показать
      const order_id = makeOrderId("TS");
      localStorage.setItem("last_order_id", order_id);
      localStorage.setItem("last_show_slug", show_slug);
      localStorage.setItem("last_seats", JSON.stringify(seats));
      localStorage.setItem("last_amount", String(amount));

      try {
        // OPTIONAL: можно заранее проверить, что seats не проданы
        // (если RLS не мешает). Если мешает — просто пропускаем.
        // const { data: sold } = await supabase.from("tickets").select("seat_label").eq("show_slug", show_slug).in("seat_label", seats);
        // if (sold?.length) { throw new Error("Деякі місця вже продані. Оновіть сторінку та оберіть інші."); }

        const payload = {
          order_id,
          amount,
          currency,
          show_slug,
          seats,
          buyer_name,
          buyer_email,
          buyer_phone,
          // result_url/server_url берутся из Secrets в Edge Function
        };

        const res = await fetch(LIQPAY_INIT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const json = await res.json();
        if (!res.ok) {
          throw new Error(json?.error || `liqpay-init error (${res.status})`);
        }

        const { data, signature } = json;
        if (!data || !signature) {
          throw new Error("liqpay-init повернув порожні data/signature");
        }

        // redirect to LiqPay checkout
        const f = document.createElement("form");
        f.method = "POST";
        f.action = "https://www.liqpay.ua/api/3/checkout";
        f.acceptCharset = "utf-8";

        const i1 = document.createElement("input");
        i1.type = "hidden";
        i1.name = "data";
        i1.value = data;

        const i2 = document.createElement("input");
        i2.type = "hidden";
        i2.name = "signature";
        i2.value = signature;

        f.appendChild(i1);
        f.appendChild(i2);
        document.body.appendChild(f);

        showMessage("Перенаправляємо на оплату LiqPay…", true);
        f.submit();
      } catch (err) {
        console.error(err);
        showMessage(err?.message || "Помилка під час ініціалізації платежу.");
        payBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
