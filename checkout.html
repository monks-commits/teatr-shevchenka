<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Підтвердження та оплата</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="site-header"></div>
  <script type="module" src="scripts/include.js"></script>

  <main class="main">
    <section class="section">
      <div class="container" style="max-width: 920px;">
        <h1>Підтвердження та оплата</h1>

        <div class="card" style="margin-bottom: 16px;">
          <div class="grid" style="display:grid; gap:10px;">
            <div><strong>Спектакль (show_slug):</strong> <span id="showSlug">—</span></div>
            <div><strong>Сума до оплати:</strong> <span id="amountLine">—</span></div>
            <div><strong>Обрані місця (для квитка):</strong><br><span id="seatsLine">—</span></div>
            <div class="meta">Формат: <strong>Ряд №, місце №</strong></div>
          </div>
        </div>

        <div class="card">
          <h2 style="margin-top:0;">Контактні дані</h2>

          <form id="payForm" class="form" style="display:grid; gap:12px;">
            <div class="grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
              <div>
                <label>Ім’я та прізвище</label>
                <input class="form-control" name="buyer_name" required placeholder="Іван Іванов" />
              </div>
              <div>
                <label>Email (куди надійде квиток)</label>
                <input class="form-control" type="email" name="buyer_email" required placeholder="name@example.com" />
              </div>
            </div>

            <div class="grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
              <div>
                <label>Телефон</label>
                <input class="form-control" name="buyer_phone" required placeholder="+380..." />
              </div>
              <div style="display:flex; align-items:flex-end;">
                <div class="meta">Після оплати сторінка LiqPay поверне вас на «Дякуємо».</div>
              </div>
            </div>

            <label class="checkbox" style="display:flex; gap:10px; align-items:center;">
              <input type="checkbox" required />
              Погоджуюсь з публічною офертою та умовами повернення.
            </label>

            <button class="button-primary" id="btnPay" type="submit">
              Оплатити через LiqPay
            </button>

            <div id="errBox" style="color:#b00020; display:none;">Помилка</div>

            <details class="meta" style="margin-top:8px;">
              <summary>Технічна довідка (для тесту)</summary>
              <pre id="debug" style="white-space:pre-wrap;"></pre>
            </details>
          </form>
        </div>
      </div>
    </section>
  </main>

  <div id="site-footer"></div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.48.0";

    // ========= CONFIG =========
    const SUPABASE_URL = "https://fhusjlkneckbvnrdhbil.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_nCCfptJOb8Lzy1uAwGBJzA_OJtDneTS";
    const LIQPAY_INIT_URL = `${SUPABASE_URL}/functions/v1/liqpay-init`;
    // ==========================

    createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function qs(name) {
      return new URLSearchParams(location.search).get(name) || "";
    }

    // ---------- IDEMPOTENCY ----------
    let idempotency_key =
      sessionStorage.getItem("idempotency_key") ||
      crypto.randomUUID();

    sessionStorage.setItem("idempotency_key", idempotency_key);
    // ---------------------------------

    function seatKeyToHuman(seatKey) {
      const m = String(seatKey).trim().match(/^([PAB])(\d+)-M(\d+)$/i);
      if (!m) return seatKey;
      return `Ряд ${m[2]}, місце ${m[3]}`;
    }

    function normalizeSeats(raw) {
      if (!raw) return [];
      let s = decodeURIComponent(raw);

      const maybeKeys = s.split(/[;,]/).map(x => x.trim()).filter(Boolean);
      const allKeys = maybeKeys.every(x => /^[PAB]\d+-M\d+$/i.test(x));
      if (allKeys) return maybeKeys.map(x => x.toUpperCase());

      const chunks = s.split(";").map(x => x.trim()).filter(Boolean);
      const keys = [];
      for (const ch of chunks) {
        const rm = ch.match(/ряд\s*(\d+)/i);
        const sm = ch.match(/місце\s*(\d+)/i);
        if (rm && sm) keys.push(`P${rm[1]}-M${sm[1]}`);
      }
      return keys;
    }

    const show_slug = qs("show") || qs("show_slug");
    const amount = Number(qs("amount") || "0");
    const seats = normalizeSeats(qs("seats"));

    // UI
    document.getElementById("showSlug").textContent = show_slug || "—";
    document.getElementById("amountLine").textContent = `${amount.toFixed(2)} UAH`;
    document.getElementById("seatsLine").textContent =
      seats.length ? seats.map(seatKeyToHuman).join("; ") : "—";

    document.getElementById("debug").textContent =
`idempotency_key=${idempotency_key}
show_slug=${show_slug}
seats=${JSON.stringify(seats)}
amount=${amount}`;

    const form = document.getElementById("payForm");
    const errBox = document.getElementById("errBox");
    const btnPay = document.getElementById("btnPay");

    let isSubmitting = false;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (isSubmitting) return;

      isSubmitting = true;
      errBox.style.display = "none";
      btnPay.disabled = true;

      try {
        if (!show_slug) throw new Error("Не передано show_slug");
        if (!seats.length) throw new Error("Не передано seats");

        const fd = new FormData(form);

        const payload = {
          idempotency_key,
          amount,
          currency: "UAH",
          show_slug,
          seats,
          buyer_name: String(fd.get("buyer_name") || "").trim(),
          buyer_email: String(fd.get("buyer_email") || "").trim(),
          buyer_phone: String(fd.get("buyer_phone") || "").trim(),
        };

        const res = await fetch(LIQPAY_INIT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const json = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(json?.error || `HTTP ${res.status}`);

        const { data, signature } = json;
        if (!data || !signature) throw new Error("init не повернув data/signature");

        const f = document.createElement("form");
        f.method = "POST";
        f.action = "https://www.liqpay.ua/api/3/checkout";
        f.acceptCharset = "utf-8";

        const i1 = document.createElement("input");
        i1.type = "hidden";
        i1.name = "data";
        i1.value = data;

        const i2 = document.createElement("input");
        i2.type = "hidden";
        i2.name = "signature";
        i2.value = signature;

        f.appendChild(i1);
        f.appendChild(i2);
        document.body.appendChild(f);
        f.submit();

      } catch (err) {
        errBox.textContent = String(err?.message || err);
        errBox.style.display = "block";
        btnPay.disabled = false;
        isSubmitting = false;
      }
    });
  </script>
</body>
</html>
