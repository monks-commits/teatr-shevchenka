<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Підтвердження та оплата</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="site-header"></div>
  <script type="module" src="scripts/include.js"></script>

  <main class="main">
    <section class="section">
      <div class="container">
        <h1>Підтвердження та оплата</h1>

        <div class="card" style="max-width:760px;margin-bottom:16px;">
          <p><b>Спектакль (show_slug):</b> <span id="showSlug"></span></p>
          <p><b>Сума до оплати:</b> <span id="amount"></span></p>
          <p><b>Обрані місця (для квитка):</b></p>
          <div id="seatsPretty" style="font-weight:700;"></div>
          <p class="meta" style="margin-top:10px;">Формат: <b>Ряд №, місце №</b></p>
        </div>

        <form id="payForm" class="card" style="max-width:760px;">
          <h2 style="margin-top:0;">Контактні дані</h2>

          <div class="form-row">
            <label>Ім’я та прізвище</label>
            <input type="text" id="buyer_name" required class="form-control" />
          </div>

          <div class="form-row">
            <label>Email (куди надійде квиток)</label>
            <input type="email" id="buyer_email" required class="form-control" />
          </div>

          <div class="form-row">
            <label>Телефон</label>
            <input type="tel" id="buyer_phone" required class="form-control" />
          </div>

          <label class="checkbox" style="margin-top:10px;">
            <input type="checkbox" id="agree" required />
            Погоджуюсь з публічною офертою та умовами повернення.
          </label>

          <button type="submit" class="button-primary" id="btnPay" style="margin-top:12px;">
            Оплатити через LiqPay
          </button>

          <div id="err" style="color:#b91c1c;margin-top:10px;"></div>

          <details style="margin-top:12px;">
            <summary>Технічна довідка (для тесту)</summary>
            <pre id="debug" style="white-space:pre-wrap;"></pre>
          </details>
        </form>
      </div>
    </section>
  </main>

  <div id="site-footer"></div>

  <script>
    // === ВАЖНО: проверь, что это URL НОВОГО Supabase, где tickets/orders/payments ===
    const SUPABASE_URL = "https://fhusjlkneckbvnrdhbil.supabase.co"; // <-- если другой project id, замени
    const LIQPAY_INIT_URL = `${SUPABASE_URL}/functions/v1/liqpay-init`;

    const p = new URLSearchParams(location.search);
    const show   = p.get("show")  || "";
    const title  = p.get("title") || "";
    const seatsRaw = p.get("seats") || "";
    const amountStr = p.get("amount") || "0";
    const amount = Number(amountStr || 0);

    const seats = seatsRaw.split(",").map(s => s.trim()).filter(Boolean);

    function seatHuman(key) {
      const m = String(key).match(/^([PAB])(\d+)-M(\d+)$/i);
      if (!m) return key;
      const row = Number(m[2]);
      const seat = Number(m[3]);
      return `Ряд ${row}, місце ${seat}`;
    }

    document.getElementById("showSlug").textContent = show || "—";
    document.getElementById("amount").textContent = `${amount.toFixed(2)} UAH`;
    document.getElementById("seatsPretty").textContent =
      seats.length ? seats.map(seatHuman).join("; ") : "—";

    const debugEl = document.getElementById("debug");
    const errEl = document.getElementById("err");
    const btnPay = document.getElementById("btnPay");

    function setError(msg) {
      errEl.textContent = msg || "";
    }

    function newIdempotencyKey() {
      // ✅ каждый клик — новый ключ → новый order_id → никаких дублей в LiqPay
      const uuid = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random());
      return "idem_" + uuid;
    }

    function submitToLiqPay(data, signature) {
      // ✅ стабильный вариант: обычный POST, без iframe
      const form = document.createElement("form");
      form.method = "POST";
      form.action = "https://www.liqpay.ua/api/3/checkout";
      form.acceptCharset = "utf-8";

      const i1 = document.createElement("input");
      i1.type = "hidden";
      i1.name = "data";
      i1.value = data;

      const i2 = document.createElement("input");
      i2.type = "hidden";
      i2.name = "signature";
      i2.value = signature;

      form.appendChild(i1);
      form.appendChild(i2);
      document.body.appendChild(form);
      form.submit();
    }

    document.getElementById("payForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      setError("");

      if (!show || !seats.length || !amount) {
        setError("Помилка: немає show/seats/amount. Поверніться і оберіть місця заново.");
        return;
      }

      const buyer_name = document.getElementById("buyer_name").value.trim();
      const buyer_email = document.getElementById("buyer_email").value.trim();
      const buyer_phone = document.getElementById("buyer_phone").value.trim();

      const idempotency_key = newIdempotencyKey();

      const payload = {
        idempotency_key,
        show_slug: show,
        seats,
        amount,
        currency: "UAH",
        buyer_name,
        buyer_email,
        buyer_phone,
      };

      debugEl.textContent = "liqpay-init payload:\n" + JSON.stringify(payload, null, 2);

      try {
        btnPay.disabled = true;

        const r = await fetch(LIQPAY_INIT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const j = await r.json().catch(() => ({}));
        debugEl.textContent += "\n\nliqpay-init response:\n" + JSON.stringify(j, null, 2);

        if (!r.ok || !j.data || !j.signature) {
          setError(j?.error || "Помилка ініціалізації оплати (liqpay-init).");
          btnPay.disabled = false;
          return;
        }

        submitToLiqPay(j.data, j.signature);
      } catch (err) {
        setError("Помилка мережі або блокування браузером. Спробуйте ще раз.");
        btnPay.disabled = false;
      }
    });
  </script>
</body>
</html>
