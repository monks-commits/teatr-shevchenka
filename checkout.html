<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Підтвердження та оплата</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="site-header"></div>
  <script type="module" src="scripts/include.js"></script>

  <main class="main">
    <section class="section">
      <div class="container" style="max-width: 920px;">
        <h1>Підтвердження та оплата</h1>

        <div class="card" style="margin-bottom: 16px;">
          <div class="grid" style="display:grid; gap:10px;">
            <div><strong>Спектакль (show_slug):</strong> <span id="showSlug">—</span></div>
            <div><strong>Сума до оплати:</strong> <span id="amountLine">—</span></div>
            <div><strong>Обрані місця (для квитка):</strong><br><span id="seatsLine">—</span></div>
            <div class="meta">Формат: <strong>Ряд №, місце №</strong></div>
          </div>
        </div>

        <div class="card">
          <h2 style="margin-top:0;">Контактні дані</h2>

          <form id="payForm" class="form" style="display:grid; gap:12px;">
            <div class="grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
              <div>
                <label>Ім’я та прізвище</label>
                <input class="form-control" name="buyer_name" required placeholder="Іван Іванов" />
              </div>
              <div>
                <label>Email (куди надійде квиток)</label>
                <input class="form-control" type="email" name="buyer_email" required placeholder="name@example.com" />
              </div>
            </div>

            <div class="grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
              <div>
                <label>Телефон</label>
                <input class="form-control" name="buyer_phone" required placeholder="+380..." />
              </div>
              <div style="display:flex; align-items:flex-end;">
                <div class="meta">Після оплати сторінка LiqPay поверне вас на «Дякуємо».</div>
              </div>
            </div>

            <label class="checkbox" style="display:flex; gap:10px; align-items:center;">
              <input type="checkbox" required />
              Погоджуюсь з публічною офертою та умовами повернення.
            </label>

            <button class="button-primary" id="btnPay" type="submit">Оплатити через LiqPay</button>

            <div id="errBox" style="color:#b00020; display:none;">Помилка</div>

            <details class="meta" style="margin-top:8px;">
              <summary>Технічна довідка (для тесту)</summary>
              <pre id="debug" style="white-space:pre-wrap;"></pre>
            </details>
          </form>
        </div>
      </div>
    </section>
  </main>

  <div id="site-footer"></div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.48.0";

    // ========= CONFIG (ЗАМІНИТИ ПІД СВІЙ НОВИЙ SUPABASE) =========
    const SUPABASE_URL = "https://fhusjlkneckbvnrdhbil.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_nCCfptJOb8Lzy1uAwGBJzA_OJtDneTS";
    const LIQPAY_INIT_URL = `${SUPABASE_URL}/functions/v1/liqpay-init`;
    // ============================================================

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function qs(name) { return new URLSearchParams(location.search).get(name) || ""; }

    // seat_key -> "Ряд X, місце Y"
    // Поддерживаем: P2-M17, A3-M10, B1-M25
    function seatKeyToHuman(seatKey) {
      const m = String(seatKey).trim().match(/^([PAB])(\d+)-M(\d+)$/i);
      if (!m) return seatKey;
      const row = m[2];
      const seat = m[3];
      return `Ряд ${row}, місце ${seat}`;
    }

    // Нормализуем вход:
    // - если пришло "P2-M17,P2-M18" -> ок
    // - если пришло "ряд 2, місце 17; ряд 2, місце 18" -> превратим в P2-M17...
    function normalizeSeats(raw) {
      if (!raw) return [];
      let s = decodeURIComponent(raw);

      // 1) если уже похоже на seat_key
      const maybeKeys = s.split(/[;,]/).map(x => x.trim()).filter(Boolean);
      const allKeys = maybeKeys.every(x => /^[PAB]\d+-M\d+$/i.test(x));
      if (allKeys) return maybeKeys.map(x => x.toUpperCase());

      // 2) пробуем вытащить "ряд N" и "місце M" из текста
      // разделим по ; (как у вас было)
      const chunks = s.split(";").map(x => x.trim()).filter(Boolean);
      const keys = [];
      for (const ch of chunks) {
        const rm = ch.match(/ряд\s*(\d+)/i);
        const sm = ch.match(/місце\s*(\d+)/i);
        if (rm && sm) keys.push(`P${rm[1]}-M${sm[1]}`);
      }
      return keys;
    }

    const show_slug = qs("show") || qs("show_slug");
    const title = qs("title");
    const amount = Number(qs("amount") || "0");
    const order_id = qs("order_id") || ("ORD-" + Date.now());

    const seatsRaw = qs("seats");
    const seats = normalizeSeats(seatsRaw);

    // UI
    document.getElementById("showSlug").textContent = show_slug || "—";
    document.getElementById("amountLine").textContent = `${amount.toFixed(2)} UAH`;
    document.getElementById("seatsLine").textContent = seats.length
      ? seats.map(seatKeyToHuman).join("; ")
      : "—";

    document.getElementById("debug").textContent =
`SUPABASE_URL=${SUPABASE_URL}
init=${LIQPAY_INIT_URL}
show_slug=${show_slug}
seats=${JSON.stringify(seats)}
amount=${amount}
order_id=${order_id}`;

    // submit
    const form = document.getElementById("payForm");
    const errBox = document.getElementById("errBox");
    const btnPay = document.getElementById("btnPay");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errBox.style.display = "none";
      btnPay.disabled = true;

      try {
        if (!show_slug) throw new Error("Не передано show_slug");
        if (!seats.length) throw new Error("Не передано seats");

        const fd = new FormData(form);
        const buyer_name = String(fd.get("buyer_name") || "").trim();
        const buyer_email = String(fd.get("buyer_email") || "").trim();
        const buyer_phone = String(fd.get("buyer_phone") || "").trim();

        // Важно: в init отправляем seats как seat_key[]
        const payload = {
          order_id,
          amount,
          currency: "UAH",
          show_slug,
          seats,
          buyer_name,
          buyer_email,
          buyer_phone,
          // result_url / server_url можно не передавать — берутся из Secrets
        };

        const res = await fetch(LIQPAY_INIT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const json = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(json?.error || `HTTP ${res.status}`);

        const { data, signature } = json;
        if (!data || !signature) throw new Error("init не повернув data/signature");

        // Редирект на LiqPay (form POST)
        const f = document.createElement("form");
        f.method = "POST";
        f.action = "https://www.liqpay.ua/api/3/checkout";
        f.acceptCharset = "utf-8";

        const in1 = document.createElement("input");
        in1.type = "hidden";
        in1.name = "data";
        in1.value = data;

        const in2 = document.createElement("input");
        in2.type = "hidden";
        in2.name = "signature";
        in2.value = signature;

        f.appendChild(in1);
        f.appendChild(in2);
        document.body.appendChild(f);
        f.submit();
      } catch (err) {
        errBox.textContent = String(err?.message || err);
        errBox.style.display = "block";
        btnPay.disabled = false;
      }
    });
  </script>
</body>
</html>
