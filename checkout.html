<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Підтвердження та оплата</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#f6f6f6; }
    .wrap { max-width: 920px; margin: 24px auto; padding: 0 16px; }
    .card { background:#fff; border-radius: 14px; padding: 18px 18px; margin: 14px 0; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    h1 { margin: 0 0 10px; font-size: 34px; }
    h2 { margin: 0 0 10px; font-size: 18px; }
    .row { margin: 6px 0; color:#222; }
    .muted { color:#666; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:10px; border:0; border-radius: 10px; padding: 12px 16px; cursor:pointer; font-weight:700; }
    .btn-primary { background:#1a73e8; color:#fff; }
    .btn-primary:disabled { opacity:.55; cursor:not-allowed; }
    .err { color:#b00020; white-space:pre-wrap; }
    .ok { color:#087f23; }
    .grid { display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 780px){ .grid{ grid-template-columns:1fr; } h1{font-size:28px;} }
    input { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #ddd; }
    label { display:block; font-size: 12px; color:#555; margin: 0 0 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Підтвердження та оплата</h1>

    <div class="card">
      <h2>Вистава</h2>
      <div class="row"><span class="muted">Назва:</span> <span id="show_title"></span></div>
      <div class="row"><span class="muted">Місця:</span> <span id="seats"></span></div>
      <div class="row"><span class="muted">Сума:</span> <span id="amount"></span></div>
      <div class="row"><span class="muted">Замовлення:</span> <span id="order_id"></span></div>
    </div>

    <div class="card">
      <h2>Дані покупця</h2>
      <div class="grid">
        <div>
          <label>Імʼя</label>
          <input id="buyer_name" placeholder="Олександр" />
        </div>
        <div>
          <label>Email</label>
          <input id="buyer_email" placeholder="name@example.com" />
        </div>
      </div>
      <div class="row muted" style="margin-top:10px;">Email обовʼязковий — на нього прийде квиток.</div>
    </div>

    <div class="card">
      <h2>Оплата онлайн</h2>
      <button id="payBtn" class="btn btn-primary">Оплатити LiqPay</button>
      <div id="status" class="row" style="margin-top:10px;"></div>
      <div id="error" class="row err" style="margin-top:10px;"></div>
      <div id="liqpayForm" style="margin-top:12px;"></div>
    </div>
  </div>

<script>
  // ====== НАСТРОЙКИ: один Supabase-проект, где лежат Edge Functions ======
  const SUPABASE_URL = "https://yqhzekifwxotizsmaeaf.supabase.co";
  const SUPABASE_ANON_KEY = "REPLACE_ME_ANON_KEY"; // <-- ВСТАВЬ СВОЙ ANON KEY (тот, что ты уже присылал)

  // Театр/сайт (можешь поменять текст)
  const THEATRE_NAME = "Театр ім. Т. Г. Шевченка";

  function qs(name){ return new URLSearchParams(location.search).get(name) || ""; }
  function setText(id, v){ document.getElementById(id).textContent = v || ""; }
  function setStatus(msg, ok=false){
    const el = document.getElementById("status");
    el.className = "row " + (ok ? "ok" : "");
    el.textContent = msg || "";
  }
  function setError(msg){ document.getElementById("error").textContent = msg || ""; }

  // Парсим параметры
  const show_slug  = qs("show");
  const show_title = qs("title") || show_slug;
  const seats_raw  = qs("seats");
  const amount_raw = qs("amount");
  const order_id   = qs("order_id") || ("ORD-" + Date.now());

  // seats -> массив строк
  const seats = seats_raw ? seats_raw.split(",").map(s => s.trim()).filter(Boolean) : [];
  const amount = Number(amount_raw || 0);

  setText("show_title", show_title);
  setText("seats", seats.length ? seats.join(", ") : "(не вказано)");
  setText("amount", (isFinite(amount) ? amount : 0) + " грн");
  setText("order_id", order_id);

  // Префилл
  document.getElementById("buyer_name").value = decodeURIComponent(qs("name") || "");
  document.getElementById("buyer_email").value = decodeURIComponent(qs("email") || "");

  async function upsertOrderV2(payload){
    // REST upsert в orders_v2 до оплаты
    const url = `${SUPABASE_URL}/rest/v1/orders_v2?on_conflict=order_id`;
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
        "Prefer": "resolution=merge-duplicates,return=representation"
      },
      body: JSON.stringify([payload])
    });
    const text = await res.text().catch(()=> "");
    if(!res.ok){
      throw new Error(`orders_v2 upsert failed: HTTP ${res.status} ${text}`);
    }
    return text;
  }

  async function initPayment(payload){
    const res = await fetch(`${SUPABASE_URL}/functions/v1/liqpay-init`, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
        "apikey": SUPABASE_ANON_KEY
      },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=> null);
    if(!res.ok){
      const msg = (data && (data.message || data.error)) || `HTTP ${res.status}`;
      throw new Error(`liqpay-init: ${msg}`);
    }
    return data;
  }

  function renderLiqpayForm({data, signature}){
    const form = document.createElement("form");
    form.method = "POST";
    form.action = "https://www.liqpay.ua/api/3/checkout";
    form.acceptCharset = "utf-8";

    const inData = document.createElement("input");
    inData.type = "hidden"; inData.name="data"; inData.value = data;

    const inSig = document.createElement("input");
    inSig.type = "hidden"; inSig.name="signature"; inSig.value = signature;

    const btn = document.createElement("button");
    btn.type = "submit";
    btn.className = "btn btn-primary";
    btn.textContent = "Перейти до оплати LiqPay";

    form.appendChild(inData);
    form.appendChild(inSig);
    form.appendChild(btn);

    const host = document.getElementById("liqpayForm");
    host.innerHTML = "";
    host.appendChild(form);
  }

  document.getElementById("payBtn").addEventListener("click", async () => {
    setError("");
    setStatus("");
    const btn = document.getElementById("payBtn");
    btn.disabled = true;

    try {
      const buyer_name  = document.getElementById("buyer_name").value.trim();
      const buyer_email = document.getElementById("buyer_email").value.trim();

      if(!buyer_email) throw new Error("Вкажи Email покупця (buyer_email).");
      if(!isFinite(amount) || amount <= 0) throw new Error("Некоректна сума amount.");

      setStatus("Записую замовлення в Supabase…");

      await upsertOrderV2({
        order_id,
        status: "pending",
        theatre: THEATRE_NAME,
        show_slug: show_slug || null,
        show_title: show_title || null,
        seats: seats.length ? seats : null,
        amount,
        currency: "UAH",
        buyer_name: buyer_name || null,
        buyer_email,
        updated_at: new Date().toISOString()
      });

      setStatus("Готую платіж LiqPay…");

      const liq = await initPayment({
        order_id,
        amount,
        currency: "UAH",
        show_slug: show_slug || null,
        seats: seats.length ? seats : null,
        result_url: `${location.origin}/thanks.html`
      });

      renderLiqpayForm(liq);
      setStatus("Форма LiqPay готова. Натисни кнопку нижче.", true);

    } catch (e) {
      setError(e?.message || String(e));
    } finally {
      btn.disabled = false;
    }
  });
</script>
</body>
</html>
