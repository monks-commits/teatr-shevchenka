<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Дякуємо за оплату</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="site-header"></div>
  <script type="module" src="scripts/include.js"></script>

  <main class="main">
    <section class="section">
      <div class="container">
        <div class="card" style="max-width:720px;">
          <h1>Дякуємо за оплату!</h1>

          <p id="msg">
            Ми отримали ваше замовлення. Якщо квиток не прийшов на email — перевірте «Спам» або напишіть нам.
          </p>

          <p><b>Номер замовлення:</b> <span id="order">—</span></p>
          <p><b>Сума:</b> <span id="amount">—</span></p>

          <a href="index.html" class="button-primary" style="margin-top:16px;display:inline-block;">
            Повернутися на сайт
          </a>

          <details style="margin-top:14px;">
            <summary>Технічна довідка</summary>
            <pre id="debug" style="white-space:pre-wrap;"></pre>
          </details>
        </div>
      </div>
    </section>
  </main>

  <div id="site-footer"></div>

  <script>
    // ===== ВСТАВЬ СЮДА ДВА ЗНАЧЕНИЯ ИЗ SUPABASE -> Project Settings -> API =====
    const SUPABASE_URL = "https://fhusjlkneckbvnrdhbil.supabase.co";        // например: https://fhusjlkneckbvnrdhbil.supabase.co
    const SUPABASE_ANON_KEY = "sb_publishable_nCCfptJOb8Lzy1uAwGBJzA_OJtDneTS";  // anon public key
    // ========================================================================

    const orderEl = document.getElementById("order");
    const amountEl = document.getElementById("amount");
    const debugEl = document.getElementById("debug");
    const msgEl = document.getElementById("msg");

    function supaHeaders() {
      return {
        apikey: SUPABASE_ANON_KEY,
        Authorization: "Bearer " + SUPABASE_ANON_KEY,
      };
    }

    async function loadLastPaid() {
      // берём самый свежий paid заказ
      const url =
        `${SUPABASE_URL}/rest/v1/orders` +
        `?status=eq.paid` +
        `&select=order_id,amount,currency,updated_at` +
        `&order=updated_at.desc` +
        `&limit=1`;

      const r = await fetch(url, { headers: supaHeaders() });
      const text = await r.text();

      debugEl.textContent =
        `GET ${url}\nstatus=${r.status}\n\nresponse:\n${text}`;

      if (!r.ok) {
        msgEl.textContent = "Оплату отримано, але дані замовлення не завантажились. Оновіть сторінку або зверніться до підтримки.";
        return;
      }

      const rows = JSON.parse(text || "[]");
      if (!rows.length) {
        msgEl.textContent = "Оплату отримано. Дані замовлення ще обробляються. Оновіть сторінку через 10–20 секунд.";
        return;
      }

      const o = rows[0];
      orderEl.textContent = o.order_id || "—";
      amountEl.textContent = `${Number(o.amount || 0).toFixed(2)} ${o.currency || "UAH"}`;
    }

    loadLastPaid().catch((e) => {
      debugEl.textContent += "\n\nerror:\n" + String(e);
      msgEl.textContent = "Сталася помилка при завантаженні даних. Оновіть сторінку.";
    });
  </script>
</body>
</html>
