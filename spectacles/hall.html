<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Схема залу</title>

  <!-- ВАЖНО: из /spectacles/ идём на уровень вверх -->
  <link rel="stylesheet" href="../styles.css" />

  <style>
    .hall-layout{
      display:flex;
      gap:24px;
      align-items:flex-start;
    }
    .hall-left{
      flex:1 1 auto;
      min-width:0;
    }
    .hall-sidebar{
      width:280px;
      flex:0 0 280px;
    }
    .hall-card{
      margin-top:0;
    }

    .hall-scroll{
      background:#e5e7eb;
      border-radius:16px;
      padding:12px;
      overflow-x:auto;
      overflow-y:visible;
      -webkit-overflow-scrolling:touch;
    }
    .hall-inner{
      width:max(980px, 100%);
      /* достаточно ширины, чтобы влезли обе ложи и правый край */
    }

    .hall-section-title{
      text-align:center;
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#6b7280;
      margin:4px 0 6px;
    }

    .hall-row{
      display:flex;
      align-items:flex-start;
      gap:8px;
      margin-bottom:16px;
    }

    .hall-row-labels{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:18px; /* чтобы не прилипало к первой строке кресел */
      min-width:26px;
      text-align:right;
      font-size:11px;
      color:#6b7280;
    }
    .row-label{
      height:24px;
      line-height:24px;
    }

    .hall-block{
      display:grid;
      grid-auto-rows:24px;
      grid-auto-flow:row;
      row-gap:4px;
    }

    .hall-block--parter{
      grid-template-columns:repeat(20,24px);
      column-gap:4px;
    }
    .hall-block--amphi{
      grid-template-columns:repeat(11,24px);
      column-gap:4px;
    }
    .hall-block--balcony{
      grid-template-columns:repeat(28,24px);
      column-gap:4px;
    }

    .hall-gap-horizontal{
      width:24px;
    }

    .seat{
      width:24px;
      height:24px;
      border-radius:6px;
      border:1px solid #d1d5db;
      background:#fff;
      font-size:11px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      padding:0;
    }
    .seat--parter-front{ background:#fef9c3; }
    .seat--parter-mid{ background:#dbeafe; }
    .seat--parter-back{ background:#e5e7eb; }
    .seat--amphi{ background:#e0f2fe; }
    .seat--balcony{ background:#f3e8ff; }
    .seat--lodge{ background:#fee2e2; }

    .seat--selected{
      background:#2563eb !important;
      color:#fff;
      border-color:#2563eb;
    }
    .seat--taken{
      background:#9ca3af !important;
      color:#fff;
      cursor:not-allowed;
    }

    /* вертикальные проходы */
    .seat--gap-right{
      margin-right:14px;
    }

    /* Ложи */
    .hall-row--lodges{
      justify-content:space-between;
      margin:8px 0 20px;
    }
    .hall-lodge{
      width:52px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
    }
    .hall-lodge-label{
      font-size:11px;
      color:#6b7280;
      margin-bottom:4px;
    }
    .hall-lodge-seats{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .hall-lodge-spacer{
      flex:1 1 auto;
    }

    .hall-summary-title{
      margin-top:0;
      margin-bottom:8px;
    }
    .hall-summary-meta{
      font-size:14px;
      color:#4b5563;
      margin:4px 0;
    }
    .hall-summary-meta b{
      font-weight:600;
    }

    .row-price-list{
      margin-top:14px;
      padding:12px 14px;
      background:#f7f7f8;
      border-radius:12px;
      font-size:14px;
    }
    .row-price{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:14px;
      color:#0f172a;
      padding:6px 0;
      border-bottom:1px dotted #e5e7eb;
    }
    .row-price:last-child{
      border-bottom:0;
    }
    .row-price .dots{
      flex:1 1 auto;
      border-bottom:1px dotted #e5e7eb;
      height:0;
      transform:translateY(-2px);
    }

    @media (max-width:900px){
      .hall-layout{
        flex-direction:column;
      }
      .hall-sidebar{
        width:auto;
      }
    }
  </style>
</head>
<body>
  <div id="site-header"></div>

  <main class="main">
    <div class="container">
      <h1>Схема залу</h1>

      <div class="hall-layout">
        <!-- Левая часть: схема -->
        <div class="hall-left">
          <div class="hall-scroll">
            <div class="hall-inner">

              <!-- Партер -->
              <div class="hall-section-title">Партер</div>
              <div class="hall-row">
                <div class="hall-row-labels" id="parter-row-labels"></div>
                <div id="hall-parter" class="hall-block hall-block--parter"></div>
              </div>

              <!-- Ложі -->
              <div class="hall-row hall-row--lodges">
                <div class="hall-lodge" id="lodge-b">
                  <div class="hall-lodge-label">Ложа Б</div>
                  <div class="hall-lodge-seats" id="lodge-b-seats"></div>
                </div>

                <div class="hall-lodge-spacer"></div>

                <div class="hall-lodge" id="lodge-a">
                  <div class="hall-lodge-label">Ложа А</div>
                  <div class="hall-lodge-seats" id="lodge-a-seats"></div>
                </div>
              </div>

              <!-- Амфітеатр -->
              <div class="hall-section-title">Амфітеатр</div>
              <div class="hall-row">
                <div class="hall-row-labels" id="amphi-row-labels"></div>
                <div id="hall-amphi-left" class="hall-block hall-block--amphi"></div>
                <div class="hall-gap-horizontal"></div>
                <div id="hall-amphi-right" class="hall-block hall-block--amphi"></div>
              </div>

              <!-- Балкон -->
              <div class="hall-section-title">Балкон</div>
              <div class="hall-row">
                <div class="hall-row-labels" id="balcony-row-labels"></div>
                <div id="hall-balcony" class="hall-block hall-block--balcony"></div>
              </div>

            </div>
          </div>

          <!-- Легенда цін -->
          <div class="row-price-list">
            <div class="row-price">
              <span>Партер, ряди 1–6</span><span class="dots"></span><b>200 грн</b>
            </div>
            <div class="row-price">
              <span>Партер, ряди 7–12</span><span class="dots"></span><b>160 грн</b>
            </div>
            <div class="row-price">
              <span>Партер, ряди 13–18</span><span class="dots"></span><b>140 грн</b>
            </div>
            <div class="row-price">
              <span>Амфітеатр (усі ряди)</span><span class="dots"></span><b>120 грн</b>
            </div>
            <div class="row-price">
              <span>Балкон, ряди 1–5</span><span class="dots"></span><b>100 грн</b>
            </div>
            <div class="row-price">
              <span>Балкон, ряд 6</span><span class="dots"></span><b>80 грн</b>
            </div>
            <div class="row-price">
              <span>Ложі А і Б</span><span class="dots"></span><b>200 грн</b>
            </div>
          </div>
        </div>

        <!-- Правая часть: заказ -->
        <aside class="hall-sidebar">
          <div class="card hall-card">
            <h2 class="hall-summary-title">Ваше замовлення</h2>
            <p id="summary-show" class="hall-summary-meta"></p>
            <p id="summary-places" class="hall-summary-meta">Обрані місця: немає</p>
            <p id="summary-amount" class="hall-summary-meta">Сума: 0 грн</p>
            <button id="go-order" class="button-primary" disabled>Перейти до оформлення</button>
            <p class="hall-summary-meta" style="font-size:12px;margin-top:10px;">
              Кнопка стане активною, коли ви оберете хоча б одне місце.
            </p>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <div id="site-footer"></div>
  <script type="module" src="../scripts/include.js"></script>

  <script>
    // ----------------- ПАРАМЕТРЫ ІЗ URL -----------------
    const qs = new URLSearchParams(location.search);
    const showSlug  = qs.get("show")  || "";
    const showTitle = qs.get("title") || showSlug || "Вистава";

    document.getElementById("summary-show").textContent =
      "Вистава: " + (showTitle || "—");

    // ----------------- КОНФИГУРАЦИЯ ЗАЛА -----------------

    // Партер: 18 рядів по 20 місць, проход після 10-го
    const parterRows = Array.from({length:18}, (_,i)=>({
      row: i+1,
      seats: 20,
      zone: "Партер",
      price: i+1 <= 6 ? 200 : (i+1 <= 12 ? 160 : 140),
      className: i+1 <= 6 ? "seat--parter-front"
               :  i+1 <=12 ? "seat--parter-mid"
                            : "seat--parter-back"
    }));

    // Амфітеатр: ліва частина 19–23 (1–11), права 19–21 (12–22)
    const amphiLeftRows  = [
      {row:19,seats:11},
      {row:20,seats:11},
      {row:21,seats:11},
      {row:22,seats:11},
      {row:23,seats:11},
    ].map(r=>({...r, zone:"Амфітеатр (ліва)", price:120, className:"seat--amphi"}));

    const amphiRightRows = [
      {row:19,seats:11},
      {row:20,seats:11},
      {row:21,seats:11},
    ].map(r=>({...r, zone:"Амфітеатр (права)", price:120, className:"seat--amphi"}));

    // Балкон: 1–5 — по 28 місць (прохід після 14), 6-й — 20 місць (прохід після 10)
    const balconyRows = [
      {row:1},{row:2},{row:3},{row:4},{row:5}
    ].map(r=>({...r, zone:"Балкон", price:100, className:"seat--balcony"}));

    const balconyRow6 = { row:6, zone:"Балкон", price:80, className:"seat--balcony" };

    // Ложі А і Б — по 18 місць вертикально
    const lodgeSeats = Array.from({length:18}, (_,i)=>({
      index:i+1,
      price:200,
      zone:"Ложа",
      className:"seat--lodge"
    }));

    // На будущее: тут можно указать выкупленные места
    const takenSeats = new Set(); // напр. "Партер-1-5"

    // ----------------- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ -----------------

    function metaKey(meta){
      return `${meta.zone}-${meta.row ?? "l"}-${meta.seat ?? meta.index}`;
    }

    function makeSeatElement(key,label,extraClass,price,meta){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = label;
      btn.className = "seat" + (extraClass ? " " + extraClass : "");
      btn.dataset.key = key;
      btn.dataset.price = price;
      btn.dataset.row = meta.row ?? "";
      btn.dataset.seat = meta.seat ?? meta.index;
      btn.dataset.zone = meta.zone;
      const taken = takenSeats.has(key);
      if (taken){
        btn.classList.add("seat--taken");
        btn.disabled = true;
      }
      btn.addEventListener("click", ()=> onSeatClick(btn, meta, price));
      return btn;
    }

    const selected = new Map(); // key -> {meta, price}

    function onSeatClick(btn, meta, price){
      const key = metaKey(meta);
      if (btn.classList.contains("seat--selected")){
        btn.classList.remove("seat--selected");
        selected.delete(key);
      } else {
        btn.classList.add("seat--selected");
        selected.set(key, {meta, price});
      }
      updateSummary();
    }

    function updateSummary(){
      const placesEl = document.getElementById("summary-places");
      const amountEl = document.getElementById("summary-amount");
      const btn      = document.getElementById("go-order");

      const items = Array.from(selected.values());
      if (!items.length){
        placesEl.textContent = "Обрані місця: немає";
        amountEl.textContent = "Сума: 0 грн";
        btn.disabled = true;
        return;
      }

      const placesStr = items
        .map(({meta})=>{
          const row  = meta.row ?? meta.index;
          const seat = meta.seat ?? meta.index;
          return `ряд ${row}, місце ${seat}`;
        })
        .join("; ");

      const total = items.reduce((sum,x)=> sum + (x.price||0), 0);

      placesEl.textContent = "Обрані місця: " + placesStr;
      amountEl.textContent = "Сума: " + total + " грн";
      btn.disabled = false;
    }

    // ----------------- РЕНДЕР СХЕМЫ -----------------

    // Партер
    (function renderParter(){
      const rowsCol = document.getElementById("parter-row-labels");
      const parterEl = document.getElementById("hall-parter");

      parterRows.forEach(r=>{
        const rl = document.createElement("div");
        rl.className = "row-label";
        rl.textContent = r.row;
        rowsCol.appendChild(rl);

        for(let s=1; s<=r.seats; s++){
          const seatMeta = {
            zone:r.zone,
            row:r.row,
            seat:s
          };
          const key = metaKey(seatMeta);
          const label = s;
          const extraClass =
            r.className + (s === 10 ? " seat--gap-right" : "");
          parterEl.appendChild(
            makeSeatElement(key,label,extraClass,r.price,seatMeta)
          );
        }
      });
    })();

    // Ложі
    (function renderLodges(){
      const a = document.getElementById("lodge-a-seats");
      const b = document.getElementById("lodge-b-seats");

      lodgeSeats.forEach(ls=>{
        const metaA = { zone:"Ложа А", index:ls.index, seat:ls.index };
        const metaB = { zone:"Ложа Б", index:ls.index, seat:ls.index };

        const keyA = metaKey(metaA);
        const keyB = metaKey(metaB);

        a.appendChild(
          makeSeatElement(keyA, ls.index, ls.className, ls.price, metaA)
        );
        b.appendChild(
          makeSeatElement(keyB, ls.index, ls.className, ls.price, metaB)
        );
      });
    })();

    // Амфітеатр
    (function renderAmphi(){
      const labels = document.getElementById("amphi-row-labels");
      const leftEl  = document.getElementById("hall-amphi-left");
      const rightEl = document.getElementById("hall-amphi-right");

      // Рядовые подписи для 19–23
      [19,20,21,22,23].forEach(r=>{
        const rl = document.createElement("div");
        rl.className = "row-label";
        rl.textContent = r;
        labels.appendChild(rl);
      });

      amphiLeftRows.forEach(r=>{
        for(let s=1; s<=r.seats; s++){
          const meta = { zone:r.zone, row:r.row, seat:s };
          const key  = metaKey(meta);
          leftEl.appendChild(
            makeSeatElement(key, s, r.className, r.price, meta)
          );
        }
      });

      amphiRightRows.forEach(r=>{
        for(let s=1; s<=r.seats; s++){
          const seatNum = s + 11; // 12–22
          const meta = { zone:r.zone, row:r.row, seat:seatNum };
          const key  = metaKey(meta);
          rightEl.appendChild(
            makeSeatElement(key, seatNum, r.className, r.price, meta)
          );
        }
      });
    })();

    // Балкон
    (function renderBalcony(){
      const labels = document.getElementById("balcony-row-labels");
      const block  = document.getElementById("hall-balcony");

      // Ряды 1–5 по 28 мест, проход после 14
      balconyRows.forEach(r=>{
        const rl = document.createElement("div");
        rl.className = "row-label";
        rl.textContent = r.row;
        labels.appendChild(rl);

        for(let s=1; s<=28; s++){
          const meta = { zone:r.zone, row:r.row, seat:s };
          const key  = metaKey(meta);
          const extraClass =
            r.className + (s === 14 ? " seat--gap-right" : "");
          block.appendChild(
            makeSeatElement(key, s, extraClass, r.price, meta)
          );
        }
      });

      // Ряд 6: 1–10 и 11–20, проход после 10-го
      const rl = document.createElement("div");
      rl.className = "row-label";
      rl.textContent = "6";
      labels.appendChild(rl);

      for(let s=1; s<=20; s++){
        const meta = { zone:balconyRow6.zone, row:6, seat:s };
        const key  = metaKey(meta);
        const extraClass =
          balconyRow6.className + (s === 10 ? " seat--gap-right" : "");
        block.appendChild(
          makeSeatElement(key, s, extraClass, balconyRow6.price, meta)
        );
      }
    })();

    // ----------------- ПЕРЕХОД НА ФОРМУ ЗАМОВЛЕННЯ -----------------

    document.getElementById("go-order").addEventListener("click", ()=>{
      const items = Array.from(selected.values());
      if (!items.length) return;

      const placesStr = items
        .map(({meta})=>{
          const row  = meta.row ?? meta.index;
          const seat = meta.seat ?? meta.index;
          return `ряд ${row}, місце ${seat}`;
        })
        .join("; ");

      const total = items.reduce((sum,x)=> sum + (x.price||0), 0);

      const u = new URL("../order.html", location.origin + location.pathname);
      const params = new URLSearchParams();
      params.set("show", showSlug);
      params.set("title", showTitle);
      params.set("seats", placesStr);
      params.set("amount", String(total));

      u.search = params.toString();
      location.href = u.toString();
    });
  </script>
</body>
</html>
